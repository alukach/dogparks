<!DOCTYPE html>
<html>
<head>
  <meta charset=utf-8 />
  <title>Nearest Dogpark</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='//api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
  <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js'></script>
  <link href='//api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.css' rel='stylesheet' />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
  </style>
</head>
<body>
  <div id='map'></div>
  <script src='account.js'></script>
  <script>
  var map = L.mapbox.map('map', 'examples.map-i86nkdio')
    .setView([51.0402, -114.0234], 12);
  var featureLayer,
      nearest_fc,
      furthest_distance,
      marker,
      initialZoom;

  // Load GeoJSON Data
  function addDataToMap(data){
    featureLayer = L.geoJson(data)
      .addTo(map);
  }

  // Get user's location
  function getLocation() {
    if (navigator.geolocation) {
      var deferred = $.Deferred();

      navigator.geolocation.getCurrentPosition(
        deferred.resolve,
        deferred.reject
      );

        return deferred.promise();
      } else {
        // TODO: Handle error better
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }

  // Add user location to map
  function createMarker(long_lat) {
    marker = L.marker([long_lat[1], long_lat[0]], {
      draggable: true,
    }).addTo(map);

    marker.on('drag', function(){
      getNearest();
    });
  }

  function panTo(long_lat) {
    map.panTo([long_lat[1], long_lat[0]]);
  }

  function getNearest() {
    var position = marker.getLatLng();
    var user_pt = turf.point([position.lng, position.lat]);

    // Iterate through polygons
    featureLayer.eachLayer(function(layer) {

      // Find nearest point
      var nearest_pt = turf.nearest(user_pt, turf.explode(layer.feature));
      var distance = turf.distance(user_pt, nearest_pt, 'kilometers');
      layer.feature.properties.distance = distance;

      // Set nearest
      nearest_fc = nearest_fc || layer;
      if (distance < nearest_fc.feature.properties.distance) {
        nearest_fc.setStyle({
          fillColor: null,
        });
        nearest_fc = layer;
      } else
      if (distance > furthest_distance) {
        furthest_distance = distance;
      }

      // Append metadata
      try {
        var human_distance = Math.round(layer.feature.properties.distance * 100) / 100;
        var content = '<h2>' + layer.feature.properties.NAME + '<\/h2>' +
          '<address>Entrance: ' + layer.feature.properties.ADDRESS + '<\/address>' +
          '<address>distance: ' + human_distance + 'KM<\/address>';
        layer.bindPopup(content);
      }
      catch (err) {
        console.warn(err);
        console.warn(layer);
        return
      }
    });
    nearest_fc.setStyle({
      fillColor: '#bd0026',
    });

    // Only zoom on load
    if (!initialZoom){
      initialZoom = true;
      var bounds = nearest_fc.getBounds().extend(user_pt);
      map.fitBounds(bounds);
    }
  }

  function handleError(err) {
    console.warn('ERROR(' + err.code + '): ' + err.message);
  };

  $(function () {
    var location = getLocation()
      .fail(handleError)
      .then(function (position) {
        return [position.coords.longitude, position.coords.latitude];
      });
    var jsonData = $.getJSON('./3_json_export/dogparks.geojson')
      .fail(handleError)
      .then(function (jqXHR) { return jqXHR; });

    $.when(location)
      .then(createMarker);

    $.when(location)
      .then(panTo);

    $.when(jsonData)
      .then(addDataToMap);

    $.when(location, jsonData)
      .done(getNearest);
  });

  </script>
</body>
</html>
